name : RAG CI Pipeline

on : 
  push :
    branches : [ "master" ]
  pull_request :
    branches : [ "master" ]

jobs :
  rag-validation :
    runs-on : ubuntu-latest

    steps :
    - name : Checkout code
      uses : actions/checkout@v4

    - name : Set up Python
      uses : actions/setup-python@4
      with :
        python-version : "3.10"

    - name : Install dependencies
      run : |
        python -m pip install --upgrade pip
        python -m pip install -r requirements.txt
    
    - name: Start MLflow UI (background)
      run: |
        python -m mlflow ui --backend-store-uri sqlite:///mlflow.db &
        sleep 5

    - name: Start FastAPI server
      run: |
        python -m uvicorn serverrag:app --host 127.0.0.1 --port 8000 &
        sleep 10

    - name: Call /chat endpoint (ML validation)
      run: |
        curl -X POST http://127.0.0.1:8000/login \
          -H "Content-Type: application/json" \
          -d '{"username":"abc","password":"abc123"}' > token.json

        TOKEN=$(cat token.json | jq -r '.access_token')

        curl -X POST http://127.0.0.1:8000/chat \
          -H "Authorization: Bearer '$TOKEN'" \
          -H "Content-Type: application/json" \
          -d '{"question":"What is this policy about?"}'